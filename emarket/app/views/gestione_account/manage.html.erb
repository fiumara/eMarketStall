<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestione Account</title>
  <%= csrf_meta_tags %>
  <%= stylesheet_link_tag 'application', media: 'all' %>
</head>
<body>
  <section class="gestione-account-container">
    <h2 class="page-title">Gestione account</h2>

    <%= form_with url: gestione_account_path, method: :get, local: true, class: "filtro-form" do %>
      <div class="filtro-row">
        <div class="form-group">
          <label for="user_type">Tipo utente</label>
          <%= select_tag :user_type, options_for_select([
            ['Tutti', 'all'],
            ['Acquirenti', 'acquirente'],
            ['Venditori', 'venditore'],
            ['Negozi segnalati', 'segnalati']
          ], selected: params[:user_type]), class: "form-control" %>
        </div>

        <div class="form-group">
          <label for="search">Cerca</label>
          <%= text_field_tag :search, params[:search], placeholder: "Cerca per nome o negozio", class: "form-control" %>
        </div>

        <div class="form-group submit-group">
          <label>&nbsp;</label>
          <%= submit_tag "Cerca", class: "btn btn-primary" %>
        </div>
      </div>
    <% end %>

    <% if @acquirente.empty? %>
      <p class="empty-result">Nessun utente trovato con i criteri selezionati.</p>
    <% end %>

    <% if params[:user_type] == "segnalati" %>
      <h3 class="subsection-title">Segnalazioni ricevute</h3>
      <% if @segnalazioni.any? %>
        <% @segnalazioni.each do |segnalazione| %>
          <div class="account-box">
            <div class="info">
              <p><strong>Negozio:</strong> <%= link_to segnalazione.negozio.nome_negozio, negozio_path(segnalazione.negozio) %></p>
              <p><strong>Motivo:</strong> <%= segnalazione.motivo.humanize %></p>
              <p><strong>Note:</strong> <%= segnalazione.note.presence || "Nessuna" %></p>
              <p><strong>Inviata da:</strong> <%= segnalazione.acquirente.nome_utente %></p>
            </div>
            <div class="azioni">
              <% if segnalazione.negozio.acquirente.bloccato? %>
                <%= button_to "Sblocca", sblocca_gestione_account_path(segnalazione.negozio.acquirente), method: :patch, class: "btn btn-unblock" %>
              <% else %>
                <%= button_to "Blocca negozio", blocca_gestione_account_path(segnalazione.negozio.acquirente), method: :patch, class: "btn btn-block" %>
              <% end %>
              <%= button_to "Elimina negozio", elimina_negozio_gestione_account_path(segnalazione.negozio.acquirente), method: :delete, data: { confirm: 'Sei sicuro di voler eliminare il profilo?' }, class: 'btn btn-danger' %>
              <%= button_to "Ignora", ignora_segnalazione_negozio_path(id: segnalazione.id), method: :delete, data: { confirm: 'Ignorare la segnalazione?' }, class: 'btn btn-secondary' %>
            </div>
          </div>
        <% end %>
      <% else %>
        <p class="empty-result">Nessuna segnalazione ricevuta.</p>
      <% end %>
    <% end %>

    <% @acquirente.each do |acquirente| %>
      <div class="account-box">
        <div class="info">
          <h3><%= acquirente.nome_utente %></h3>
          <p><%= acquirente.nome %> <%= acquirente.cognome %></p>
          <% if acquirente.negozio.present? %>
            <p>Negozio: <%= acquirente.negozio.nome_negozio %></p>
          <% end %>
        </div>
        <div class="azioni">
          <% if acquirente.bloccato? %>
            <%= button_to "Sblocca", sblocca_gestione_account_path(acquirente), method: :patch, class: "btn btn-unblock" %>
          <% else %>
            <%= button_to "Blocca", blocca_gestione_account_path(acquirente), method: :patch, class: "btn btn-block" %>
          <% end %>
          <%= button_to "Elimina", elimina_gestione_account_path(acquirente), method: :delete, data: { confirm: "Sei sicuro di voler eliminare questo utente?" }, class: "btn btn-danger" %>
        </div>
      </div>
    <% end %>
  </section>
</body>
</html>
