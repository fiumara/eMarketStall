<h2 class="mb-4">Dettaglio Ordine: <%= @ordine.codice_ordine %></h2>

<p><strong>Data:</strong> <%= @ordine.created_at.strftime("%d/%m/%Y %H:%M") %></p>
<p><strong>Stato:</strong> <%= @ordine.stato.humanize %></p>
<p><strong>Indirizzo di spedizione:</strong> <%= @ordine.indirizzo %></p>

<hr>

<h4>Prodotti inclusi</h4>
<table class="table table-striped table-bordered">
  <thead class="table-light">
    <tr>
      <th>Nome</th>
      <th>Quantità</th>
      <th>Prezzo originale</th>
      <th>Prezzo applicato</th>
      <th>Totale </th>
    </tr>
  </thead>
  <tbody>
    <% @ordine.ordine_items.each do |item| %>
      <% if item.prodotto.nil? || item.prodotto.negozio_id == @negozio.id %>
        <tr>
          <td><%= item.nome_prodotto || "Prodotto eliminato" %></td>
          <td><%= item.quantity %></td>
          <td><%= number_to_currency(item.prodotto&.prezzo || item.prezzo) %></td>
          <td>
            <% if item.prodotto && item.prodotto.prezzo_scontato < item.prodotto.prezzo %>
              <strong><%= number_to_currency(item.prodotto.prezzo_scontato) %></strong>
              <small class="text-success">(Scontato)</small>
            <% else %>
              <%= number_to_currency(item.prezzo) %>
            <% end %>
          </td>
          <td><%= number_to_currency(item.prezzo * item.quantity) %></td>
        </tr>
      <% end %>
    <% end %>
  </tbody>
</table>

<hr>

<h4>Riepilogo Totale</h4>
<p>
  <strong>Totale ordine:</strong> <%= number_to_currency(@ordine.totale) %><br>
  <% if @ordine.sconto.present? && @ordine.sconto > 0 %>
    <span class="text-success"><strong>Sconto applicato:</strong> -<%= number_to_currency(@ordine.sconto) %></span><br>
    <small class="text-muted">(Promozioni o punti fedeltà)</small>
  <% end %>
</p>

<hr>

<h4>Aggiorna Stato Ordine</h4>
<%= form_with url: negozio_ordine_path(@negozio, @ordine), method: :patch, class: "mt-3" do |f| %>
  <div class="mb-3">
    <%= f.label :stato, "Stato Ordine", class: "form-label" %>
    <%= f.select :stato, Ordine.statos.keys.map { |s| [s.humanize, s] }, {}, class: "form-select" %>
  </div>
  <%= f.submit "Aggiorna Stato", class: "btn btn-success" %>
<% end %>
